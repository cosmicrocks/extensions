name: sysbox
variant: alpine
shell: /toolchain/bin/bash
dependencies:
  - stage: base
steps:
  - sources:
      - url: https://github.com/nestybox/sysbox/archive/refs/tags/v0.6.3.tar.gz
        destination: sysbox.tar.gz
        sha256: 68d53c40c061e767ce760c5c6fde6cbd7687d8ba06f36455c0aa46b15a1a8a05
        sha512: ae3d325ded6e9621c2ad9df23df4d6fd3e5646fbd31ca6cd0f8f519a6aa5a5ad15e4d352a6c632f885c90c8d55c5d9ae4512e8eef0b02c49c9f10fb3962f3a6f
    env:
      GOPATH: /go
    prepare:
      - |
        apk add --no-cache \
          git \
          build-base \
          linux-headers

        mkdir -p /usr/src
        ln -s /usr/include/linux /usr/src/linux-headers-$(uname -r)
      - |
        sed -i 's#$VERSION#{{ .VERSION }}#' /pkg/manifest.yaml
      - |
        mkdir -p ${GOPATH}/src/github.com/nestybox/sysbox

        tar -xzf sysbox.tar.gz --strip-components=1 -C ${GOPATH}/src/github.com/nestybox/sysbox
    build:
      - |
        export PATH=${PATH}:${TOOLCHAIN}/go/bin

        cd ${GOPATH}/src/github.com/nestybox/sysbox

        git clone https://github.com/nestybox/sysbox.git
        cd sysbox
        git submodule update --init --recursive
        protoc --version && sleep 100
        # make sysbox-static-local

    install:
      - |
        mkdir -p /rootfs/usr/local/bin
        make install DESTDIR=/rootfs/usr/local/bin
finalize:
  - from: /rootfs
    to: /rootfs
  - from: /pkg/manifest.yaml
    to: /
  - from: /pkg/sysbox.part
    to: /rootfs/etc/cri/conf.d/sysbox.part
  - from: /pkg/runsc.toml
    to: /rootfs/etc/cri/conf.d/runsc.toml
